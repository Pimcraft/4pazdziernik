<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domówka: Kuchnie Świata!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --primary-color: #e94560;
            --text-color: #e0e0e0;
            --text-muted: #a7a7a7;
            --border-color: #0f3460;
            --border-radius: 16px;
            --font-main: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 2rem 1rem; }
        .container { background-color: var(--card-color); border: 1px solid var(--border-color); padding: 2rem 2.5rem; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); width: 100%; max-width: 900px; text-align: center; transition: all 0.3s ease; margin-bottom: 2rem; }
        h1, h2, h3 { font-weight: 700; margin-bottom: 1rem; }
        h1 { color: var(--primary-color); font-size: 2.5rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.2rem; color: var(--text-muted); }
        p { color: var(--text-muted); line-height: 1.6; margin-bottom: 1.5rem; }
        .lore-section { text-align: left; margin: 2rem 0; padding: 1.5rem; background-color: rgba(15, 52, 96, 0.3); border-radius: var(--border-radius); border-left: 4px solid var(--primary-color); }
        .lore-section p { margin-bottom: 0.5rem; }
        .button-group { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; }
        button, .button { background: var(--primary-color); color: white; border: none; padding: 0.8rem 1.8rem; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        button:hover, .button:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4); }
        button:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        button.secondary { background: var(--border-color); }
        .form-group { margin: 1.5rem 0; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }
        select, .radio-group { width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.8rem 1rem; border-radius: 8px; font-size: 1rem; font-family: var(--font-main); }
        .radio-group { display: flex; justify-content: space-around; }
        
        /* --- NOWE STYLE ANIMACJI --- */
        #carousel-container {
            height: 120px;
            width: 100%;
            margin: 2rem auto;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }
        #carousel-track {
            display: flex;
            position: relative;
            left: 50%;
        }
        .carousel-item {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            margin: 0 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--border-color);
            border-radius: 10px;
            transition: transform 0.3s ease;
        }
        .carousel-item .icon { font-size: 2.5rem; }
        .carousel-item .name { font-size: 0.8rem; font-weight: 600; margin-top: 5px; }

        #carousel-pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background-color: var(--primary-color);
            z-index: 10;
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* Klasa dodawana do uruchomienia animacji */
        .spinning {
            transition: left 5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #results-table th, #results-table td { padding: 0.8rem 1rem; text-align: left; }
        #results-table thead { background-color: var(--border-color); }
        #results-table tbody tr { border-bottom: 1px solid var(--border-color); }
        #results-table tbody tr:nth-child(even) { background-color: rgba(15, 52, 96, 0.3); }
        .hidden { display: none !important; }
        
         /* --- NOWE STYLE SEKCJI SZCZEGÓŁÓW --- */
        .details-section {
            text-align: left;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        .details-section h2 {
            text-align: center;
            color: var(--primary-color);
        }
        .details-box {
            background-color: rgba(15, 52, 96, 0.3);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 2rem;
        }
        .details-box h3 {
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .transport-table {
            width: 100%;
            font-size: 0.9rem;
        }
        .transport-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .transport-table td:first-child {
            width: 140px;
            white-space: nowrap;
        }
        .map-gallery {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }
        .map-gallery img {
            width: 31%;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .map-gallery img:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
        }
        
        /* --- STYLE MODALA (POWIĘKSZONEGO ZDJĘCIA) --- */
        #lightbox {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        #lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--border-radius);
        }
        #lightbox .close {
            position: absolute;
            top: 2rem;
            right: 2rem;
            font-size: 3rem;
            color: white;
            cursor: pointer;
        }
         .transport-icon {
            display: inline-block;
            width: 30px;
            text-align: center;
        }
		/* --- NOWE STYLE PODSUMOWANIA --- */
        #summary-stats {
            display: flex;
            justify-content: space-around;
            background-color: rgba(15, 52, 96, 0.4);
            padding: 1rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            font-weight: 600;
        }
        #summary-stats strong {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }

        #results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        /* --- NOWE STYLE GALERII KUCHNI --- */
		.cuisine-gallery {
		    display: flex;           /* Ustawia elementy w rzędzie */
		    flex-wrap: wrap;         /* Pozwala elementom zawijać się do nowego wiersza */
		    justify-content: center; /* Wyśrodkowuje kafelki w poziomie */
		    gap: 8px;                /* Tworzy mały odstęp między kafelkami */
		    margin-top: 1.5rem;      /* Odstęp od nagłówka "Pula Dostępnych Kuchni" */
		}

		/* --- MOBILE ULEPSZENIA DLA SEKCIJI SZCZEGÓŁÓW --- */
@media (max-width: 768px) {
  .details-section {
    padding: 0 0.5rem;
  }

  .details-section h2 {
    font-size: 1.6rem;
    line-height: 1.2;
    margin-bottom: 0.25rem;
  }

  .details-box {
    padding: 1rem;
    border: 1px solid var(--border-color);
    background: rgba(15, 52, 96, 0.45);
  }

  .details-box h3 {
    font-size: 1.05rem;
    line-height: 1.3;
    gap: 0.4rem;
  }

  .details-box p {
    font-size: 0.95rem;
  }

  /* Transport: z tabeli na „karty” */
  .transport-table {
    display: block;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .transport-table tbody {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .transport-table tr {
    display: grid;
    grid-template-columns: 1fr;
    background: rgba(15, 52, 96, 0.35);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 0.75rem 0.9rem;
  }

  .transport-table td {
    display: block;
    border: 0;
    padding: 0.25rem 0;
  }

  .transport-table td:first-child {
    width: auto;
    white-space: normal;
    font-weight: 700;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-bottom: 0.25rem;
  }

  .transport-table td:last-child {
    color: var(--text-muted);
    padding-top: 0;
  }

  .transport-icon {
    width: 28px;
    text-align: center;
    flex: 0 0 28px;
  }

  /* Mapy: pełna szerokość i wygodne odstępy */
  .map-gallery {
    flex-direction: column;
    gap: 0.75rem;
    align-items: stretch;
  }

  .map-gallery img {
    width: 100%;
    max-width: 100%;
    border-radius: 12px;
  }

  /* Lightbox: większy przycisk zamknięcia dla palców */
  #lightbox .close {
    top: 1rem;
    right: 1rem;
    font-size: 2.5rem;
    padding: 0.25rem 0.5rem;
  }
}

		
		/* Zmniejszamy rozmiar kafelków wewnątrz galerii */
		.cuisine-gallery .carousel-item {
		    width: 85px;  /* Nowa, mniejsza szerokość */
		    height: 85px; /* Nowa, mniejsza wysokość */
		    margin: 0;    /* Usuwamy stary margines na rzecz właściwości 'gap' */
		}
		
		/* Zmniejszamy ikonę, aby pasowała do mniejszego kafelka */
		.cuisine-gallery .carousel-item .icon {
		    font-size: 2rem;
		}
		
		/* Zmniejszamy tekst pod ikoną */
		.cuisine-gallery .carousel-item .name {
		    font-size: 0.7rem;
		    font-weight: 500;
		}
		
		/* Style dla zajętych, przekreślonych kuchni */
		.cuisine-gallery .carousel-item.unavailable {
		    opacity: 0.4;
		    filter: grayscale(1);
		    text-decoration: line-through;
		    cursor: not-allowed;
		    transform: none; /* Wyłącza efekt "podnoszenia się" przy najechaniu myszką */
		}
		
		/* Dodatkowa reguła, aby na pewno nie było efektu hover na zajętych */
		.cuisine-gallery .carousel-item.unavailable:hover {
		    transform: none;
		    box-shadow: none;
		}
		/* --- NOWE STYLE DLA LICZNIKA --- */
		#countdown-timer {
		    display: flex;
		    justify-content: center;
		    gap: 1rem;
		    margin: 1.5rem 0;
		    font-weight: 300;
		    font-size: 0.9rem;
		    color: var(--text-muted);
		}
		#countdown-timer div {
		    background-color: rgba(15, 52, 96, 0.4);
		    padding: 0.8rem;
		    border-radius: 8px;
		    width: 80px;
		    text-align: center;
		}
		#countdown-timer span {
		    display: block;
		    font-size: 2.5rem;
		    font-weight: 700;
		    color: var(--primary-color);
		    line-height: 1.1;
		}
		/* --- NOWE STYLE DLA DYMKU Z PORADAMI --- */
		#tip-bubble {
		    margin: 1.5rem auto 0;
		    max-width: 80%;
		    background-color: rgba(15, 52, 96, 0.5);
		    border-left: 3px solid var(--primary-color);
		    padding: 1rem 1.5rem;
		    border-radius: 0 var(--border-radius) var(--border-radius) 0;
		    text-align: center;
		    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
		    opacity: 0; /* Domyślnie ukryty */
		    transform: translateY(20px); /* Startuje lekko niżej */
		}
		
		#tip-bubble.visible {
		    opacity: 1;
		    transform: translateY(0);
		}
		
		#tip-bubble p {
		    color: var(--text-muted);
		    font-style: italic;
		    margin-bottom: 0;
		    font-size: 0.9rem;
		}
    </style>
</head>
<body>
<div id="lightbox" class="hidden">
        <span class="close">&times;</span>
        <img id="lightbox-img" src="">
    </div>

    <div class="container">
        <div id="content-wrapper">
             <div id="step-invite">
                <h1>Domówka: Kuchnie Świata! 🗺️</h1>
                <h3>Zaproszenie na epicką podróż kulinarną</h3>
				 <div id="countdown-timer">
				    <div><span id="days">00</span>Dni</div>
				    <div><span id="hours">00</span>Godzin</div>
				    <div><span id="minutes">00</span>Minut</div>
				    <div><span id="seconds">00</span>Sekund</div>
				</div>
				 <div id="tip-bubble">
				    <p id="tip-text">Ładowanie protokołu... dobrej zabawy...</p>
				</div>
                <p>Zanim przejdziemy dalej, odpowiedz na jedno, arcyważne pytanie...</p>
                <h2>Czy <u>4 października</u> masz ochotę uczestniczyć w tej imprezie?</h2>
                <div class="lore-section">
                    <p>🌶️ <strong>Idea jest prosta:</strong> Każdy uczestnik (lub para) losuje kuchnię i przygotowuje jedno, charakterystyczne dla niej danie.</p>
                    <p>🎲 <strong>Na miejscu czekają:</strong> Zacne trunki, gry bez prądu, integracja i ploteczki do oporu.</p>
                     <p>🤝 <strong>Cel:</strong> Spróbować pysznego jedzenia i świetnie się bawić w doborowym towarzystwie!</p>
                </div>

                <div class="details-box" style="margin-top: 2rem; text-align: left;">
                    <h3 style="text-align: center;">🍲 Pula Dostępnych Kuchni</h3>
                    <div class="cuisine-gallery" id="cuisine-gallery-invite">
                        </div>
                </div>
                                <div class="button-group">
                    <button id="btn-attend-yes">🎉 Tak, będę!</button>
                    <button id="btn-attend-no" class="secondary">😢 Niestety, nie tym razem</button>
                </div>
            </div>

            <div id="step-details" class="hidden">
                <h2>Super, że będziesz!</h2>
                <p>Uzupełnij jeszcze dwie rzeczy, abyśmy mogli wszystko przygotować.</p>
                <div class="form-group">
                    <label>Jestem...</label>
                    <select id="person-select"></select>
                </div>
                <div class="form-group">
                    <label>Czy będziesz z osobą towarzyszącą?</label>
                    <div class="radio-group" id="guest-choice">
                        <label><input type="radio" name="guest" value="yes" checked> Tak</label>
                        <label><input type="radio" name="guest" value="no"> Nie</label>
                    </div>
                </div>
                <button id="btn-to-drawing">Przejdź do losowania</button>
            </div>

            <div id="step-drawing" class="hidden">
                <h2>Czas na losowanie!</h2>
                <p>Kliknij przycisk i poznaj swoje kulinarne przeznaczenie.</p>
                <div id="carousel-container">
                    <div id="carousel-pointer"></div>
                    <div id="carousel-track"></div>
                </div>
                <button id="spin-button">Rozpocznij losowanie!</button>
            </div>
			<div id="step-refuse" class="hidden">
				<h2>Czy na pewno? 🤔</h2>
				<p>Wybierz swoje imię z listy, aby potwierdzić, że jednak Cię nie będzie.</p>
				<div class="form-group">
					<label>Jestem...</label>
					<select id="refuse-person-select"></select>
				</div>
				<div class="button-group">
					<button id="btn-confirm-refusal" class="secondary">Potwierdzam rezygnację</button>
					<button id="btn-cancel-refusal">Jednak będę!</button>
				</div>
			</div>

        </div>
        
        <div id="results-section">
            <h2 id="result-announcement"></h2>
            
            <div id="summary-stats">
                <span>✅ Potwierdzeni: <strong id="stats-attending">0</strong></span>
                <span>❌ Odmowy: <strong id="stats-declined">0</strong></span>
                <span>❔ Czekamy: <strong id="stats-pending">0</strong></span>
            </div>
                        <h3>Aktualna lista gości i kuchni</h3>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Imię</th>
                        <th>Obecność</th>
                        <th>+1</th>
                        <th>Wylosowana Kuchnia</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="4">Ładowanie danych...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="container details-section">
        <h2>Szczegóły Imprezy</h2>
        
        <div class="details-box">
            <h3>🗓️ Czas, Miejsce i Zasady</h3>
            <p><strong>Kiedy:</strong> Sobota, 4 października 2025, start o <strong>18:00</strong>.<br>
               <strong>Gdzie:</strong> ul. Awicenny 32a/12, Wrocław.</p>
            <p style="margin-bottom: 0;">Każda osoba/para przygotowuje <strong>tylko jedno danie</strong> z wylosowanej kuchni. Prosimy nie przynosić za dużo jedzenia, aby nic się nie zmarnowało!</p>
        </div>

        <div class="details-box">
            <h3>🥂 Alkohole i Nastrój</h3>
            <p>🍷 Zapewniamy podstawowe ilości <strong>wina białego wytrawnego</strong>.<br>
               🥃 Dostępna będzie również butelka <strong>whisky</strong>.<br>
               🧊 Dla fanów mocniejszych trunków czekać będzie zmrożona <strong>wódka</strong>.<br>
               🥤 Oczywiście postawię też kilka <strong>napojów bezalkoholowych</strong> i przekąsek.<br>
               👕 Obowiązuje strój <strong>luźny i wygodny</strong>.<br>
               😊 Nastrój: <strong>poprawny</strong> (przynajmniej na starcie)!
            </p>
        </div>

         <div class="details-box">
            <h3>❗ Ważne Info / Alergeny</h3>
            <p style="margin-bottom: 0;">🐈‍⬛ Ostrzeżenie dla alergików i pedantów! W domu rezydują dwa koty (<strong>czarny ⚫</strong> i <strong>biało-bury ⚪</strong>). Ich sierść jest integralną częścią wystroju mieszkania i na pewno wyjdziecie nią oblepieni. Zapewniamy rolkę do ubrań! ✨</p>
        </div>

        <div class="details-box">
            <h3>🚗 Transport i Dojazd</h3>
            <table class="transport-table">
                <tbody>
                    <tr><td><span class="transport-icon">✈️</span> Lotnisko</td><td>ok. 20 min samochodem</td></tr>
                    <tr><td><span class="transport-icon">🚆</span> Dworzec Zach.</td><td>ok. 5 min pieszo 🚶</td></tr>
                    <tr><td><span class="transport-icon">🅿️</span> Parking Biedronka</td><td>2 min pieszo 🚶</td></tr>
                    <tr><td><span class="transport-icon">🚌</span> <strong>Chachaja</strong></td><td>Linia: 132 (pod samym domem)</td></tr>
                    <tr><td><span class="transport-icon">🚌</span> <strong>Jordanowska</strong></td><td>Linie: 132, 125, 907, 947 (4 min pieszo 🚶)</td></tr>
                    <tr><td><span class="transport-icon">🚌</span> <strong>Wiejska</strong></td><td>Linie: 107, 119, 125, 132, 143, 251, 257, 319, 607, 907, 947 (7 min pieszo 🚶)</td></tr>
                    <tr><td><span class="transport-icon">🚊</span> <strong>Pętla Oporów</strong></td><td>Tramwaje: 4, 11, 20. Autobusy: 107, 119, 125, 143, 251, 319 (8 min pieszo 🚶)</td></tr>
                    <tr><td><span class="transport-icon">🚢</span> Statek</td><td>Ruch morski niedostępny</td></tr>
                    <tr><td><span class="transport-icon">🛸</span> Dron</td><td>Ruch dronowy dostępny tylko ze wschodu</td></tr>
                </tbody>
            </table>
        </div>

         <div class="details-box">
            <h3>🗺️ Mapy Dojazdu (kliknij, aby powiększyć)</h3>
<div class="map-gallery">
  <img src="1.png" alt="Mapa okolicy" loading="lazy" decoding="async">
  <img src="2.png" alt="Mapa transportu" loading="lazy" decoding="async">
  <img src="3.png" alt="Mapa parkingu" loading="lazy" decoding="async">
</div>
        </div>
    </div>
    

<script>
// 1. KONFIGURACJA
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwGqjTi-HuolG4nSiv2ekMlkm7c2-bd9TqYvJoiRZ7xPaZITdulpg7imLZUSRuelDauA/exec';
const MAX_RETRIES = 5;

// 2. REFERENCJE DO ELEMENTÓW DOM
const naggingQuestions = [
    "Ale na pewno? Będzie pyszne jedzonko...",
    "A co z doborowym towarzystwem? Tego też nie chcesz?",
    "Poważnie? Nawet koty będą tęsknić...",
    "Ostatnia szansa... Może jednak się skusisz?",
    "To ostateczna decyzja? Bez Ciebie to nie będzie to samo!"
];

const steps = {
    invite: document.getElementById('step-invite'),
    details: document.getElementById('step-details'),
    drawing: document.getElementById('step-drawing'),
    refuse: document.getElementById('step-refuse'), // Ta linia jest nowa
};
const contentWrapper = document.getElementById('content-wrapper');
const resultsSection = document.getElementById('results-section');
const personSelect = document.getElementById('person-select');
const historyBody = document.getElementById('history-body');
const spinButton = document.getElementById('spin-button');
const resultAnnouncement = document.getElementById('result-announcement');
const carouselTrack = document.getElementById('carousel-track');

// 3. STAN APLIKACJI
let appData = {
    participants: [],
    availableCuisines: []
};
let currentUser = { name: null };
let isSpinning = false;

// 4. FUNKCJE NAWIGACYJNE I WIDOKU
const goToStep = (stepName) => {
    Object.values(steps).forEach(step => step.classList.add('hidden'));
    if (steps[stepName]) {
        steps[stepName].classList.remove('hidden');
    }
};
	// POCZĄTEK NOWEJ FUNKCJI
const updateSummaryStats = () => {
    if (!appData.participants) return;

    let attendingCount = 0;
    let declinedCount = 0;
    let pendingCount = 0;

    appData.participants.forEach(p => {
        if (p.attending === true) {
            attendingCount++; // Osoba z listy
            if (p.guest) {
                attendingCount++; // Jej osoba towarzysząca
            }
        } else if (p.attending === false) {
            declinedCount++;
        } else { // p.attending jest null
            pendingCount++;
        }
    });

    document.getElementById('stats-attending').textContent = attendingCount;
    document.getElementById('stats-declined').textContent = declinedCount;
    document.getElementById('stats-pending').textContent = pendingCount;
};
const renderInviteCuisineGallery = () => {
    const gallery = document.getElementById('cuisine-gallery-invite');
    if (!gallery || !appData.participants || !appData.availableCuisines) return;

    gallery.innerHTML = '';

    const drawnCuisines = appData.participants
        .filter(p => p.cuisine)
        .map(p => {
            const parts = p.cuisine.split(' ');
            const icon = parts.pop();
            const name = parts.join(' ');
            return { name, icon };
        });

    const allCuisines = [...appData.availableCuisines, ...drawnCuisines];
    allCuisines.sort((a, b) => a.name.localeCompare(b.name));
    const availableNames = new Set(appData.availableCuisines.map(c => c.name));

    allCuisines.forEach(cuisine => {
        const item = document.createElement('div');
        item.className = 'carousel-item';
        if (!availableNames.has(cuisine.name)) {
            item.classList.add('unavailable');
        }
        item.innerHTML = `<span class="icon">${cuisine.icon}</span><span class="name">${cuisine.name}</span>`;
        gallery.appendChild(item);
    });
};

const renderHistoryTable = () => {
	updateSummaryStats();
	renderInviteCuisineGallery();
    historyBody.innerHTML = '';
    if (!appData.participants || appData.participants.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4">Brak danych o uczestnikach.</td></tr>';
        return;
    }
    appData.participants.forEach(p => {
        const row = document.createElement('tr');
        const attendingText = p.attending === null ? '❔' : (p.attending ? '✅ Tak' : '❌ Nie');
        const guestText = p.attending ? (p.guest ? '👤 Tak' : '➖ Nie') : '➖';
        const cuisineText = p.attending ? (p.cuisine || '<em>Czeka na losowanie</em>') : '➖';
        row.innerHTML = `<td data-label="Imię">${p.base}</td><td data-label="Obecność">${attendingText}</td><td data-label="+1">${guestText}</td><td data-label="Kuchnia">${cuisineText}</td>`;
        historyBody.appendChild(row);
    });
};

const initializeCarousel = (cuisines) => {
    carouselTrack.innerHTML = '';
    const extendedCuisines = [...cuisines, ...cuisines, ...cuisines, ...cuisines, ...cuisines];
    
    extendedCuisines.forEach(cuisine => {
        const item = document.createElement('div');
        item.className = 'carousel-item';
        item.innerHTML = `<span class="icon">${cuisine.icon}</span><span class="name">${cuisine.name}</span>`;
        carouselTrack.appendChild(item);
    });
};
	

// 5. LOGIKA DANYCH I API
const delay = ms => new Promise(res => setTimeout(res, ms));

const fetchWithRetry = async (url, options, retries = MAX_RETRIES) => {
    for (let i = 0; i <= retries; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                 throw new Error(`Błąd HTTP: ${response.status}`);
            }
            return response;
        } catch (error) {
            console.error(`Próba ${i + 1} nieudana:`, error.message);
            if (i === retries) {
                console.error("Osiągnięto maksymalną liczbę prób. Poddaję się.");
                throw error;
            }
            await delay(1000 * (i + 1)); // Czekaj 1, 2, 3... sekundy
        }
    }
};

	
	const cuisineTips = {
    "default": [
        "Ciekawe, kto pierwszy zapyta o hasło do Wi-Fi...",
        "Plotka głosi, że gospodarze ukryli najlepsze trunki. Czas na poszukiwania!",
        "Pamiętaj: kalorie zjedzone w dobrym towarzystwie nie tuczą. To fakt naukowy.",
        "Trwa zakulisowa walka o to, kto przyniesie najlepsze danie. Stawki są wysokie.",
        "Jeśli muzyka będzie zła, pamiętaj, że zawsze można zacząć grać w planszówki.",
        "Koty już oceniają, czyje kolana będą dziś najlepszym tronem. Przygotuj się."
    ],
    "Niemiecka": [
        "${name}, liczymy na porządny, niemiecki Ordnung na talerzu! Würst musi być idealnie prosty.",
        "Czy to prawda, ${name}, że Twój Schnitzel będzie większy niż mapa Berlina? Zobaczymy!",
        "Słyszałem, że ${name} robi sałatkę ziemniaczaną. Oby była tak solidna jak niemiecka motoryzacja."
    ],
    "Angielska": [
        "Good heavens, ${name}! Czy to będzie fish and chips, czy może shepherd's pie?",
        "Mam nadzieję, że danie od ${name} będzie lepsze niż angielska pogoda!",
        "Jeśli ${name} robi Yorkshire pudding, to rezerwuję sobie od razu trzy sztuki."
    ],
    "Indyjska": [
        "${name}, czy Twoje curry będzie tak aromatyczne, że sąsiedzi zapukają z własnymi talerzami?",
        "Podobno ${name} robi butter chicken, który jest bardziej kremowy niż obietnice polityków. Czekam!",
        "Jeśli ${name} przyniesie coś z dużą ilością chili, przygotujcie gaśnice... i szklanki z mlekiem."
    ],
    "Gruziń.": [ // <-- Dodany klucz
        "Gaumarjos, ${name}! Czy Twoje chaczapuri będzie miało wystarczająco dużo sera, by uszczęśliwić cały naród?",
        "Słyszałem, że ${name} szykuje chinkali. Uczymy się je jeść bez utraty cennego rosołku!",
        "Jeśli ${name} przyniesie wino z Gruzji, impreza oficjalnie osiągnie status legendy."
    ],
    "Hiszp.": [ // <-- Poprawiony klucz
        "${name}, czy Twoja paella będzie miała więcej owoców morza niż jest uczestników imprezy?",
        "Tapas od ${name}? Brzmi jak idealny plan, żeby spróbować wszystkiego i nie wybrać niczego konkretnego. Jak w życiu.",
        "Czy sangria od ${name} będzie na tyle mocna, żebyśmy wszyscy zaczęli mówić po hiszpańsku? ¡Ojalá!"
    ],
    "Francuska": [ // <-- Dodany klucz
        "Bonjour, ${name}! Czy Twoje danie będzie tak wykwintne, jak francuskie perfumy?",
        "Jeśli ${name} robi zupę cebulową, to mam nadzieję, że będzie miała grzankę z serem grubą na palec.",
        "Bagietki, sery, wino... ${name}, czy Ty na pewno robisz jedno danie, a nie całą francuską ucztę?"
    ],
    // Poniżej reszta kuchni z poprzedniej wersji, na wszelki wypadek
    "Meksykańska": [
        "Hola ${name}! Czy Twoje tacos będą tak ostre, jak atmosfera po trzeciej kolejce?",
        "${name}, mam nadzieję, że Twoja quesadilla będzie bardziej sycąca niż plotki, które dziś usłyszymy. 😉"
    ],
    "Włoska": [
        "Mamma mia, ${name}! Czy to będzie pizza na cienkim, czy grubym... podkładzie do dobrej imprezy?",
        "Podobno ${name} robi tiramisu tak dobre, że anioły śpiewają. Czekamy na ten niebiański chór!"
    ],
    "Japońska": [
        "${name}, czy Twoje sushi będzie zwinięte równie perfekcyjnie, co plany na tę noc?",
        "Uważajcie! Podobno wasabi od ${name} potrafi odblokować wspomnienia z poprzednich wcieleń."
    ],
    "Polska": [
        "Hej, ${name}! Czy Twoje pierogi będą z wody czy odsmażane? To pytanie dzieli naród bardziej niż polityka.",
        "Schabowy od ${name} podobno ma rozmiar małego kontynentu. Przygotujcie żołądki."
    ]
};

	const startTipCarousel = () => {
    const tipBubble = document.getElementById('tip-bubble');
    const tipText = document.getElementById('tip-text');
    if (!tipBubble || !tipText) return;

    let messagePlaylist = [];

    // 1. Zbierz potwierdzonych gości z przypisaną kuchnią
    const confirmedGuests = appData.participants.filter(p => p.attending === true && p.cuisine);

    // 2. Stwórz spersonalizowaną listę tekstów
    if (confirmedGuests.length > 0) {
        confirmedGuests.forEach(guest => {
            const cuisineFullName = guest.cuisine; // np. "Meksykańska 🌮"
            const cuisineBaseName = Object.keys(cuisineTips).find(key => cuisineFullName.includes(key));
            
            if (cuisineBaseName && cuisineTips[cuisineBaseName]) {
                const personalizedTips = cuisineTips[cuisineBaseName].map(tip => tip.replace('${name}', guest.base));
                messagePlaylist.push(...personalizedTips);
            }
        });
    }

    // 3. Jeśli nie ma spersonalizowanych tekstów, użyj domyślnych
    if (messagePlaylist.length === 0) {
        messagePlaylist.push(...cuisineTips.default);
    }

    // 4. Wymieszaj teksty dla lepszego efektu
    messagePlaylist.sort(() => Math.random() - 0.5);
    
    let currentTipIndex = 0;

    const showNextTip = () => {
        // Ukryj dymek (animacja fade-out)
        tipBubble.classList.remove('visible');

        // Poczekaj na koniec animacji ukrywania
        setTimeout(() => {
            // Zmień tekst
            tipText.textContent = messagePlaylist[currentTipIndex];
            currentTipIndex = (currentTipIndex + 1) % messagePlaylist.length;
            
            // Pokaż dymek z nowym tekstem (animacja fade-in)
            tipBubble.classList.add('visible');
        }, 600); // Czas musi być nieco dłuższy niż transition w CSS
    };
    
    // Pokaż pierwszy tekst od razu
    setTimeout(showNextTip, 2000); // Dajmy chwilę na załadowanie strony

    // Ustaw interwał zmiany tekstów
    setInterval(showNextTip, 8000); // Zmieniaj tekst co 8 sekund
};

const loadData = async () => {
    try {
        const response = await fetchWithRetry(GOOGLE_SCRIPT_URL); 
        const data = await response.json();
        appData = data;
        renderHistoryTable();
        populatePersonSelect();
        populateRefuseSelect();
		startTipCarousel();
    } catch (error) {
        console.error("Błąd ładowania danych z Google Sheets:", error);
        historyBody.innerHTML = '<tr><td colspan="4">Nie udało się załadować danych. Odśwież stronę.</td></tr>';
    }
};

const saveData = async () => {
    try {
        await fetchWithRetry(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            redirect: "follow", 
            headers: {
                "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify(appData)
        });
        // Po zapisie odświeżamy dane, aby mieć pewność, że wszystko jest aktualne
        await loadData();
    } catch (error) {
        console.error("Błąd zapisu danych do Google Sheets:", error);
        resultAnnouncement.innerHTML = `<h2 style="color:red">Błąd zapisu! Spróbuj ponownie.</h2>`;
    }
};


const populatePersonSelect = () => {
    personSelect.innerHTML = '';
    let availablePeople = 0;
    if (appData.participants) {
        appData.participants.forEach(p => {
            if (p.attending === null || (p.attending && !p.cuisine)) {
                const option = document.createElement('option');
                option.value = p.base;
                option.textContent = p.declined;
                personSelect.appendChild(option);
                availablePeople++;
            }
        });
    }
    if (availablePeople === 0) {
        document.getElementById('step-details').innerHTML = '<p>Wygląda na to, że wszyscy już wzięli udział. Zobacz wyniki poniżej!</p>';
    }
};

const startCarousel = () => {
    if (isSpinning) return;
    const availableCuisines = appData.availableCuisines;
    if (!availableCuisines || availableCuisines.length === 0) {
        alert("Wszystkie kuchnie zostały już wylosowane!");
        return;
    }

    isSpinning = true;
    spinButton.disabled = true;

    const randomIndex = Math.floor(Math.random() * availableCuisines.length);
    const selectedCuisine = availableCuisines[randomIndex];

    const targetIndex = availableCuisines.length + randomIndex;
    const itemWidth = 120;
    const targetPosition = - (targetIndex * itemWidth) + (carouselTrack.parentElement.clientWidth / 2) - (itemWidth / 2);

    carouselTrack.classList.add('spinning');
    carouselTrack.style.left = `${targetPosition}px`;

    setTimeout(async () => {
        const cuisineString = selectedCuisine.name + " " + selectedCuisine.icon;
        resultAnnouncement.innerHTML = `<h2>Gratulacje, <span style="color:var(--primary-color)">${currentUser.name}!</span></h2>
                                      <p>Twoje przeznaczenie to: <strong>${cuisineString}</strong></p>`;
        
        const personIndex = appData.participants.findIndex(p => p.base === currentUser.name);
        if (personIndex > -1) {
            appData.participants[personIndex].cuisine = cuisineString;
            appData.availableCuisines.splice(randomIndex, 1);
        }
        
        await saveData();
        isSpinning = false;
        contentWrapper.classList.add('hidden');
    }, 5100);
};
// DODAJ całą tę nową funkcję
const populateRefuseSelect = () => {
    const refuseSelect = document.getElementById('refuse-person-select');
    refuseSelect.innerHTML = '';
    let availablePeople = 0;
    if (appData.participants) {
        appData.participants.forEach(p => {
            // Pokaż osoby niezdecydowane (null) lub te, które już potwierdziły (true)
            if (p.attending === null || p.attending === true) {
                const option = document.createElement('option');
                option.value = p.base;
                option.textContent = p.declined;
                refuseSelect.appendChild(option);
                availablePeople++;
            }
        });
    }
    if (availablePeople === 0) {
        document.getElementById('step-refuse').innerHTML = '<p>Wygląda na to, że wszyscy już podjęli ostateczną decyzję!</p>';
    }
};

// DODAJ całą tę nową funkcję
const handleRefusal = async () => {
    const refuseSelect = document.getElementById('refuse-person-select');
    const name = refuseSelect.value;
    if (!name) return;

    // Pętla z męczącymi pytaniami
    for (const question of naggingQuestions) {
        if (!confirm(question)) {
            alert("Uff, co za ulga! Dobrze, że zostajesz! 😄");
            goToStep('invite');
            return; // Przerwij proces odmowy
        }
    }

    const personIndex = appData.participants.findIndex(p => p.base === name);
    if (personIndex > -1) {
        const person = appData.participants[personIndex];

        // Sprawdź, czy osoba miała przypisaną kuchnię
        if (person.cuisine) {
            const cuisineString = person.cuisine;
            // Proste parsowanie: "Nazwa Kuchni  эмодзи"
            const parts = cuisineString.split(' ');
            const icon = parts.pop();
            const cuisineName = parts.join(' ');
            
            // Stwórz obiekt kuchni i dodaj go z powrotem do puli
            const returnedCuisine = { name: cuisineName, icon: icon };
            appData.availableCuisines.push(returnedCuisine);
            
            // Opcjonalnie: sortuj listę kuchni dla porządku
            appData.availableCuisines.sort((a, b) => a.name.localeCompare(b.name));
        }

        // Zaktualizuj dane osoby
        person.attending = false;
        person.guest = false; // Resetuj osobę towarzyszącą
        person.cuisine = null; // Usuń kuchnię

        await saveData();
        contentWrapper.classList.add('hidden');
        resultAnnouncement.innerHTML = `<h2>Szkoda, że Cię nie będzie, ${name}.</h2><p>Dzięki za informację! Do zobaczenia następnym razem.</p>`;
    }
};

// 7. INICJALIZACJA I OBSŁUGA ZDARZEŃ
document.addEventListener('DOMContentLoaded', () => {
    
    document.getElementById('btn-attend-yes').addEventListener('click', () => {
	    goToStep('details');
	    // DODANA LINIA: Płynne przewinięcie do nowego widoku
	    document.getElementById('step-details').scrollIntoView({ behavior: 'smooth', block: 'center' });
	});

    document.getElementById('btn-attend-no').addEventListener('click', () => {
		goToStep('refuse');
	});
	
	document.getElementById('btn-confirm-refusal').addEventListener('click', handleRefusal);
	document.getElementById('btn-cancel-refusal').addEventListener('click', () => goToStep('invite'));
    
    document.getElementById('btn-to-drawing').addEventListener('click', () => {
        currentUser.name = personSelect.value;
        const personData = appData.participants.find(p => p.base === currentUser.name);

        if (personData && personData.cuisine) {
            alert('Już brałeś/aś udział w losowaniu! Zobacz swój wynik w tabeli.');
            contentWrapper.classList.add('hidden');
            resultAnnouncement.innerHTML = `<h2>Twój wynik jest już w tabeli, ${personData.base}!</h2>`;
            return;
        }

        const personIndex = appData.participants.findIndex(p => p.base === currentUser.name);
        if (personIndex > -1) {
            appData.participants[personIndex].attending = true;
            appData.participants[personIndex].guest = document.querySelector('input[name="guest"]:checked').value === 'yes';
        }
        
        initializeCarousel(appData.availableCuisines);
        goToStep('drawing');
    });

    spinButton.addEventListener('click', startCarousel);
    
    loadData();
    goToStep('invite');
});
// --- DODATKOWA LOGIKA DLA GALERII MAP ---
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const galleryImages = document.querySelectorAll('.map-gallery img');

    galleryImages.forEach(img => {
        img.addEventListener('click', () => {
            lightbox.classList.remove('hidden');
            lightbox.classList.add('active');
            lightboxImg.src = img.src;
        });
    });

    lightbox.addEventListener('click', (e) => {
        if (e.target !== e.currentTarget && e.target.tagName !== 'SPAN') return;
        lightbox.classList.remove('active');
        setTimeout(() => {
            lightbox.classList.add('hidden');
        }, 300);
    });
	const partyDate = new Date('2025-10-04T18:00:00').getTime();
const countdownInterval = setInterval(() => {
    const now = new Date().getTime();
    const distance = partyDate - now;

    if (distance < 0) {
        clearInterval(countdownInterval);
        document.getElementById('countdown-timer').innerHTML = "<h2>Impreza trwa w najlepsze!</h2>";
        return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    document.getElementById('days').innerText = String(days).padStart(2, '0');
    document.getElementById('hours').innerText = String(hours).padStart(2, '0');
    document.getElementById('minutes').innerText = String(minutes).padStart(2, '0');
    document.getElementById('seconds').innerText = String(seconds).padStart(2, '0');
}, 1000);

</script>

</body>
</html>

















