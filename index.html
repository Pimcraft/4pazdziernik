<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domówka: Kuchnie Świata!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --primary-color: #e94560;
            --text-color: #e0e0e0;
            --text-muted: #a7a7a7;
            --border-color: #0f3460;
            --border-radius: 16px;
            --font-main: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 2rem 1rem; }
        .container { background-color: var(--card-color); border: 1px solid var(--border-color); padding: 2rem 2.5rem; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); width: 100%; max-width: 900px; text-align: center; transition: all 0.3s ease; margin-bottom: 2rem; }
        h1, h2, h3 { font-weight: 700; margin-bottom: 1rem; }
        h1 { color: var(--primary-color); font-size: 2.5rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.2rem; color: var(--text-muted); }
        p { color: var(--text-muted); line-height: 1.6; margin-bottom: 1.5rem; }
        .lore-section { text-align: left; margin: 2rem 0; padding: 1.5rem; background-color: rgba(15, 52, 96, 0.3); border-radius: var(--border-radius); border-left: 4px solid var(--primary-color); }
        .lore-section p { margin-bottom: 0.5rem; }
        .button-group { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; }
        button, .button { background: var(--primary-color); color: white; border: none; padding: 0.8rem 1.8rem; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        button:hover, .button:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4); }
        button:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        button.secondary { background: var(--border-color); }
        .form-group { margin: 1.5rem 0; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }
        select, .radio-group { width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.8rem 1rem; border-radius: 8px; font-size: 1rem; font-family: var(--font-main); }
        .radio-group { display: flex; justify-content: space-around; }
        
        /* --- NOWE STYLE ANIMACJI --- */
        #carousel-container {
            height: 120px;
            width: 100%;
            margin: 2rem auto;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }
        #carousel-track {
            display: flex;
            position: relative;
            left: 50%;
        }
        .carousel-item {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            margin: 0 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--border-color);
            border-radius: 10px;
            transition: transform 0.3s ease;
        }
        .carousel-item .icon { font-size: 2.5rem; }
        .carousel-item .name { font-size: 0.8rem; font-weight: 600; margin-top: 5px; }

        #carousel-pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background-color: var(--primary-color);
            z-index: 10;
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* Klasa dodawana do uruchomienia animacji */
        .spinning {
            transition: left 5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #results-table th, #results-table td { padding: 0.8rem 1rem; text-align: left; }
        #results-table thead { background-color: var(--border-color); }
        #results-table tbody tr { border-bottom: 1px solid var(--border-color); }
        #results-table tbody tr:nth-child(even) { background-color: rgba(15, 52, 96, 0.3); }
        .hidden { display: none !important; }
        
         /* --- NOWE STYLE SEKCJI SZCZEGÓŁÓW --- */
        .details-section {
            text-align: left;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        .details-section h2 {
            text-align: center;
            color: var(--primary-color);
        }
        .details-box {
            background-color: rgba(15, 52, 96, 0.3);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 2rem;
        }
        .details-box h3 {
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .transport-table {
            width: 100%;
            font-size: 0.9rem;
        }
        .transport-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .transport-table td:first-child {
            width: 140px;
            white-space: nowrap;
        }
        .map-gallery {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }
        .map-gallery img {
            width: 31%;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .map-gallery img:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
        }
        
        /* --- STYLE MODALA (POWIĘKSZONEGO ZDJĘCIA) --- */
        #lightbox {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        #lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--border-radius);
        }
        #lightbox .close {
            position: absolute;
            top: 2rem;
            right: 2rem;
            font-size: 3rem;
            color: white;
            cursor: pointer;
        }
         .transport-icon {
            display: inline-block;
            width: 30px;
            text-align: center;
        }
		/* --- NOWE STYLE PODSUMOWANIA --- */
        #summary-stats {
            display: flex;
            justify-content: space-around;
            background-color: rgba(15, 52, 96, 0.4);
            padding: 1rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            font-weight: 600;
        }
        #summary-stats strong {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }

        #results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        /* --- NOWE STYLE GALERII KUCHNI --- */
		.cuisine-gallery {
		    display: flex;           /* Ustawia elementy w rzędzie */
		    flex-wrap: wrap;         /* Pozwala elementom zawijać się do nowego wiersza */
		    justify-content: center; /* Wyśrodkowuje kafelki w poziomie */
		    gap: 8px;                /* Tworzy mały odstęp między kafelkami */
		    margin-top: 1.5rem;      /* Odstęp od nagłówka "Pula Dostępnych Kuchni" */
		}

		/* --- MOBILE ULEPSZENIA DLA SEKCIJI SZCZEGÓŁÓW --- */
/* ===== MOBILE (<=768px) – pełny pakiet stylów ===== */
@media (max-width: 768px) {

  /* Layout i typografia */
  body { padding: 1.25rem 0.75rem; }
  .container { padding: 1.25rem 1rem; }
  h1 { font-size: 1.9rem; line-height: 1.2; }
  h2 { font-size: 1.4rem; line-height: 1.25; }
  h3 { font-size: 1.05rem; line-height: 1.3; }

  /* Formularze i przyciski */
  .form-group { margin: 1.1rem 0; }
  label { font-size: 0.85rem; }
  select, .radio-group { font-size: 0.95rem; padding: 0.7rem 0.9rem; }
  .radio-group { gap: .75rem; justify-content: space-between; }
  .radio-group label { display: flex; align-items: center; gap: .4rem; }
  .button-group { flex-direction: column; gap: .75rem; }
  button, .button { width: 100%; padding: 0.85rem 1rem; }

  /* Karuzela losowania */
  #carousel-container { height: 100px; margin: 1.25rem 0; }
  .carousel-item { width: 88px; height: 88px; margin: 0 6px; }
  .carousel-item .icon { font-size: 2rem; }
  .carousel-item .name { font-size: 0.7rem; }

  /* Licznik czasu */
  #countdown-timer { gap: .6rem; margin: 1rem 0; font-size: 0.85rem; }
  #countdown-timer div { width: 72px; padding: 0.6rem; }
  #countdown-timer span { font-size: 2rem; }

  /* Dymek z poradami */
  #tip-bubble { max-width: 100%; margin-top: 1rem; padding: .85rem 1rem; }
  #tip-bubble p { font-size: .9rem; }

  /* Podsumowanie (statystyki) */
  #summary-stats { 
    flex-wrap: wrap; 
    gap: .5rem; 
    justify-content: space-between; 
    padding: .75rem; 
  }
  #summary-stats span { flex: 1 1 calc(50% - .5rem); text-align: center; }

  /* ===== Tabela wyników → kafelki ===== */
  #results-table thead { display: none !important; }
  #results-table { border-collapse: separate; width: 100%; }
  #results-table tbody { display: block; }
  #results-table tbody tr {
    display: block;
    margin: 0 0 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: rgba(15, 52, 96, 0.25);
  }
  #results-table tbody tr:nth-child(even) { background: rgba(15, 52, 96, 0.25); }
  #results-table td {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    padding: .65rem .85rem;
    border: 0;
    text-align: right;
    white-space: normal;
    word-break: break-word;
  }
  #results-table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--text-muted);
    text-align: left;
    margin-right: .75rem;
  }

  /* ===== Sekcja „Szczegóły Imprezy” ===== */
  .details-section { padding: 0 .5rem; }
  .details-section h2 { font-size: 1.6rem; margin-bottom: .25rem; }
  .details-box {
    padding: 1rem;
    border: 1px solid var(--border-color);
    background: rgba(15, 52, 96, 0.45);
  }
  .details-box h3 { font-size: 1.05rem; line-height: 1.3; gap: .4rem; }
  .details-box p { font-size: .95rem; }

  /* Transport: tabela → karty */
  .transport-table { display: block; width: 100%; border-collapse: separate; border-spacing: 0; }
  .transport-table tbody {
    display: grid;
    grid-template-columns: 1fr;
    gap: .75rem;
  }
  .transport-table tr {
    display: grid;
    grid-template-columns: 1fr;
    background: rgba(15, 52, 96, 0.35);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: .75rem .9rem;
  }
  .transport-table td { display: block; border: 0; padding: .25rem 0; }
  .transport-table td:first-child {
    width: auto;
    white-space: normal;
    font-weight: 700;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: .5rem;
    padding-bottom: .25rem;
  }
  .transport-table td:last-child { color: var(--text-muted); padding-top: 0; }
  .transport-icon { width: 28px; text-align: center; flex: 0 0 28px; }

  /* Galerie map – jedna kolumna */
  .map-gallery { flex-direction: column; gap: .75rem; align-items: stretch; }
  .map-gallery img { width: 100%; max-width: 100%; border-radius: 12px; }

  /* Lightbox – łatwiejsze trafienie kciukiem */
  #lightbox .close { top: 1rem; right: 1rem; font-size: 2.5rem; padding: .25rem .5rem; }

  /* Galeria kuchni – ciaśniejsze kafelki */
  .cuisine-gallery { gap: 6px; }
  .cuisine-gallery .carousel-item { width: 80px; height: 80px; }
  .cuisine-gallery .carousel-item .icon { font-size: 1.8rem; }
  .cuisine-gallery .carousel-item .name { font-size: .68rem; }

  /* Dodatkowe oddechy pod sekcją wyników */
  #results-section { padding-bottom: .5rem; }
}


		
		/* Zmniejszamy rozmiar kafelków wewnątrz galerii */
		.cuisine-gallery .carousel-item {
		    width: 85px;  /* Nowa, mniejsza szerokość */
		    height: 85px; /* Nowa, mniejsza wysokość */
		    margin: 0;    /* Usuwamy stary margines na rzecz właściwości 'gap' */
		}
		
		/* Zmniejszamy ikonę, aby pasowała do mniejszego kafelka */
		.cuisine-gallery .carousel-item .icon {
		    font-size: 2rem;
		}
		
		/* Zmniejszamy tekst pod ikoną */
		.cuisine-gallery .carousel-item .name {
		    font-size: 0.7rem;
		    font-weight: 500;
		}
		
		/* Style dla zajętych, przekreślonych kuchni */
		.cuisine-gallery .carousel-item.unavailable {
		    opacity: 0.4;
		    filter: grayscale(1);
		    text-decoration: line-through;
		    cursor: not-allowed;
		    transform: none; /* Wyłącza efekt "podnoszenia się" przy najechaniu myszką */
		}
		
		/* Dodatkowa reguła, aby na pewno nie było efektu hover na zajętych */
		.cuisine-gallery .carousel-item.unavailable:hover {
		    transform: none;
		    box-shadow: none;
		}
		/* --- NOWE STYLE DLA LICZNIKA --- */
		#countdown-timer {
		    display: flex;
		    justify-content: center;
		    gap: 1rem;
		    margin: 1.5rem 0;
		    font-weight: 300;
		    font-size: 0.9rem;
		    color: var(--text-muted);
		}
		#countdown-timer div {
		    background-color: rgba(15, 52, 96, 0.4);
		    padding: 0.8rem;
		    border-radius: 8px;
		    width: 80px;
		    text-align: center;
		}
		#countdown-timer span {
		    display: block;
		    font-size: 2.5rem;
		    font-weight: 700;
		    color: var(--primary-color);
		    line-height: 1.1;
		}
		/* --- NOWE STYLE DLA DYMKU Z PORADAMI --- */
		#tip-bubble {
    position: relative; /* Potrzebne do pozycjonowania "ogonka" */
    margin: 2.5rem auto 0; /* Zwiększony margines górny dla "ogonka" */
    max-width: 80%;
    /* Nowy, atrakcyjny gradient */
    background: linear-gradient(145deg, var(--border-color), var(--card-color));
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* Wyraźniejszy cień */
    padding: 1.2rem 1.8rem;
    border-radius: var(--border-radius); /* Zaokrąglenie rogów */
    text-align: center;
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    opacity: 0; /* Domyślnie ukryty */
    transform: translateY(20px);
}

/* --- NOWE STYLE DLA POWIADOMIEŃ TYPU TOAST --- */
/* --- ZAKTUALIZOWANE STYLE DLA POWIADOMIEŃ TYPU TOAST --- */
#toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    z-index: 2000;
    width: clamp(280px, 80vw, 350px);
    /* Zapobiega "przeciekaniu" kliknięć na elementy pod spodem */
    pointer-events: none; 
}

.toast-notification {
    width: 100%;
    background: linear-gradient(145deg, var(--border-color), var(--card-color));
    color: var(--text-color);
    padding: 16px 20px;
    border-radius: 12px;
    border: 1px solid #0f3460;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    font-size: 0.9rem;
    line-height: 1.5;
    pointer-events: auto; /* Umożliwia klikanie w powiadomienie */
    
    /* Nowa, połączona animacja trwająca 7.5s */
    animation: toast-lifecycle 10.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;}

/* Ta klasa jest teraz używana tylko do natychmiastowego usunięcia */
.toast-notification.exit {
    animation: slideOut 0.5s cubic-bezier(0.5, 0, 0.75, 0) forwards;
}
		/* Dodaj tę klasę w sekcji <style> */
.toast-name-highlight {
    color: var(--primary-color);
    font-weight: 600;
}

/* ZMIANA: Zaktualizowane klatki kluczowe dla dłuższego czasu */
@keyframes toast-lifecycle {
    /* Faza wejścia (0s -> 0.5s) */
    0% { transform: translateX(120%); }
    5% { transform: translateX(0); } /* 0.5s / 10.5s ≈ 5% */
    
    /* Faza wyświetlania (0.5s -> 10s) */
    95% { transform: translateX(0); } /* 10s / 10.5s ≈ 95% */

    /* Faza wyjścia (10s -> 10.5s) */
    100% { transform: translateX(120%); }
}

@keyframes slideOut {
    from { transform: translateX(0); }
    to { transform: translateX(120%); }
}


/* --- STYLE DLA TELEFONÓW --- */
@media (max-width: 768px) {
    #toast-container {
        right: 10px;
        bottom: 10px;
        left: 10px;
        width: auto;
    }
}
    </style>
</head>
<body>
<div id="lightbox" class="hidden">
        <span class="close">&times;</span>
        <img id="lightbox-img" src="">
    </div>

    <div class="container">
        <div id="content-wrapper">
             <div id="step-invite">
                <h1>Domówka: Kuchnie Świata! 🗺️</h1>
                <h3>Zaproszenie na epicką podróż kulinarną</h3>
				 <div id="countdown-timer">
				    <div><span id="days">00</span>Dni</div>
				    <div><span id="hours">00</span>Godzin</div>
				    <div><span id="minutes">00</span>Minut</div>
				    <div><span id="seconds">00</span>Sekund</div>
				</div>

                <p>Zanim przejdziemy dalej, odpowiedz na jedno, arcyważne pytanie...</p>
                <h2>Czy <u>4 października</u> masz ochotę uczestniczyć w tej imprezie?</h2>
                <div class="lore-section">
                    <p>🌶️ <strong>Idea jest prosta:</strong> Każdy uczestnik (lub para) losuje kuchnię i przygotowuje jedno, charakterystyczne dla niej danie.</p>
                    <p>🎲 <strong>Na miejscu czekają:</strong> Zacne trunki, gry bez prądu, integracja i ploteczki do oporu.</p>
                     <p>🤝 <strong>Cel:</strong> Spróbować pysznego jedzenia i świetnie się bawić w doborowym towarzystwie!</p>
                </div>

                <div class="details-box" style="margin-top: 2rem; text-align: left;">
                    <h3 style="text-align: center;">🍲 Pula Dostępnych Kuchni</h3>
                    <div class="cuisine-gallery" id="cuisine-gallery-invite">
                        </div>
                </div>
                                <div class="button-group">
                    <button id="btn-attend-yes">🎉 Tak, będę!</button>
                    <button id="btn-attend-no" class="secondary">😢 Niestety, nie tym razem</button>
                </div>
            </div>

            <div id="step-details" class="hidden">
                <h2>Super, że będziesz!</h2>
                <p>Uzupełnij jeszcze dwie rzeczy, abyśmy mogli wszystko przygotować.</p>
                <div class="form-group">
                    <label>Jestem...</label>
                    <select id="person-select"></select>
                </div>
                <div class="form-group">
                    <label>Czy będziesz z osobą towarzyszącą?</label>
                    <div class="radio-group" id="guest-choice">
                        <label><input type="radio" name="guest" value="yes" checked> Tak</label>
                        <label><input type="radio" name="guest" value="no"> Nie</label>
                    </div>
                </div>
                <button id="btn-to-drawing">Przejdź do losowania</button>
            </div>

            <div id="step-drawing" class="hidden">
                <h2>Czas na losowanie!</h2>
                <p>Kliknij przycisk i poznaj swoje kulinarne przeznaczenie.</p>
                <div id="carousel-container">
                    <div id="carousel-pointer"></div>
                    <div id="carousel-track"></div>
                </div>
                <button id="spin-button">Rozpocznij losowanie!</button>
            </div>
			<div id="step-refuse" class="hidden">
				<h2>Czy na pewno? 🤔</h2>
				<p>Wybierz swoje imię z listy, aby potwierdzić, że jednak Cię nie będzie.</p>
				<div class="form-group">
					<label>Jestem...</label>
					<select id="refuse-person-select"></select>
				</div>
				<div class="button-group">
					<button id="btn-confirm-refusal" class="secondary">Potwierdzam rezygnację</button>
					<button id="btn-cancel-refusal">Jednak będę!</button>
				</div>
			</div>

        </div>
        
        <div id="results-section">
            <h2 id="result-announcement"></h2>
            
            <div id="summary-stats">
                <span>✅ Potwierdzeni: <strong id="stats-attending">0</strong></span>
                <span>❌ Odmowy: <strong id="stats-declined">0</strong></span>
                <span>❔ Czekamy: <strong id="stats-pending">0</strong></span>
            </div>
                        <h3>Aktualna lista gości i kuchni</h3>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Imię</th>
                        <th>Obecność</th>
                        <th>+1</th>
                        <th>Wylosowana Kuchnia</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="4">Ładowanie danych...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="container details-section">
        <h2>Szczegóły Imprezy</h2>
        
        <div class="details-box">
            <h3>🗓️ Czas, Miejsce i Zasady</h3>
            <p><strong>Kiedy:</strong> Sobota, 4 października 2025, start o <strong>18:00</strong>.<br>
               <strong>Gdzie:</strong> ul. Awicenny 32a/12, Wrocław.</p>
            <p style="margin-bottom: 0;">Każda osoba/para przygotowuje <strong>tylko jedno danie</strong> z wylosowanej kuchni. Prosimy nie przynosić za dużo jedzenia, aby nic się nie zmarnowało!</p>
        </div>

        <div class="details-box">
            <h3>🥂 Alkohole i Nastrój</h3>
            <p>🍷 Zapewniamy podstawowe ilości <strong>wina białego wytrawnego</strong>.<br>
               🥃 Dostępna będzie również butelka <strong>whisky</strong>.<br>
               🧊 Dla fanów mocniejszych trunków czekać będzie zmrożona <strong>wódka</strong>.<br>
               🥤 Oczywiście postawię też kilka <strong>napojów bezalkoholowych</strong> i przekąsek.<br>
               👕 Obowiązuje strój <strong>luźny i wygodny</strong>.<br>
               😊 Nastrój: <strong>poprawny</strong> (przynajmniej na starcie)!
            </p>
        </div>

         <div class="details-box">
            <h3>❗ Ważne Info / Alergeny</h3>
            <p style="margin-bottom: 0;">🐈‍⬛ Ostrzeżenie dla alergików i pedantów! W domu rezydują dwa koty (<strong>czarny ⚫</strong> i <strong>biało-bury ⚪</strong>). Ich sierść jest integralną częścią wystroju mieszkania i na pewno wyjdziecie nią oblepieni. Zapewniamy rolkę do ubrań! ✨</p>
        </div>

        <div class="details-box">
            <h3>🚗 Transport i Dojazd</h3>
            <table class="transport-table">
                <tbody>
                    <tr><td><span class="transport-icon">✈️</span> Lotnisko</td><td>ok. 20 min samochodem</td></tr>
                    <tr><td><span class="transport-icon">🚆</span> Dworzec Zach.</td><td>ok. 5 min pieszo 🚶</td></tr>
                    <tr><td><span class="transport-icon">🅿️</span> Parking Biedronka</td><td>2 min pieszo 🚶</td></tr>
                    <tr><td><span class="transport-icon">🚌</span> <strong>Chachaja</strong></td><td>Linia: 132 (pod samym domem)</td></tr>
                    <tr><td><span class="transport-icon">🚌</span> <strong>Jordanowska</strong></td><td>Linie: 132, 125, 907, 947 (4 min pieszo 🚶)</td></tr>
                    <tr><td><span class="transport-icon">🚌</span> <strong>Wiejska</strong></td><td>Linie: 107, 119, 125, 132, 143, 251, 257, 319, 607, 907, 947 (7 min pieszo 🚶)</td></tr>
                    <tr><td><span class="transport-icon">🚊</span> <strong>Pętla Oporów</strong></td><td>Tramwaje: 4, 11, 20. Autobusy: 107, 119, 125, 143, 251, 319 (8 min pieszo 🚶)</td></tr>
                    <tr><td><span class="transport-icon">🚢</span> Statek</td><td>Ruch morski niedostępny</td></tr>
                    <tr><td><span class="transport-icon">🛸</span> Dron</td><td>Ruch dronowy dostępny tylko ze wschodu</td></tr>
                </tbody>
            </table>
        </div>

         <div class="details-box">
            <h3>🗺️ Mapy Dojazdu (kliknij, aby powiększyć)</h3>
<div class="map-gallery">
  <img src="1.png" alt="Mapa okolicy" loading="lazy" decoding="async">
  <img src="2.png" alt="Mapa transportu" loading="lazy" decoding="async">
  <img src="3.png" alt="Mapa parkingu" loading="lazy" decoding="async">
</div>
        </div>
    </div>
    <div id="toast-container"></div>

<script>
// 1. KONFIGURACJA
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwGqjTi-HuolG4nSiv2ekMlkm7c2-bd9TqYvJoiRZ7xPaZITdulpg7imLZUSRuelDauA/exec';
const MAX_RETRIES = 5;

// 2. REFERENCJE DO ELEMENTÓW DOM
const naggingQuestions = [
    "Ale na pewno? Będzie pyszne jedzonko...",
    "A co z doborowym towarzystwem? Tego też nie chcesz?",
    "Poważnie? Nawet koty będą tęsknić...",
    "Ostatnia szansa... Może jednak się skusisz?",
    "To ostateczna decyzja? Bez Ciebie to nie będzie to samo!"
];

const steps = {
    invite: document.getElementById('step-invite'),
    details: document.getElementById('step-details'),
    drawing: document.getElementById('step-drawing'),
    refuse: document.getElementById('step-refuse'), // Ta linia jest nowa
};
const contentWrapper = document.getElementById('content-wrapper');
const resultsSection = document.getElementById('results-section');
const personSelect = document.getElementById('person-select');
const historyBody = document.getElementById('history-body');
const spinButton = document.getElementById('spin-button');
const resultAnnouncement = document.getElementById('result-announcement');
const carouselTrack = document.getElementById('carousel-track');

// 3. STAN APLIKACJI
let appData = {
    participants: [],
    availableCuisines: []
};
let currentUser = { name: null };
let isSpinning = false;

// 4. FUNKCJE NAWIGACYJNE I WIDOKU
const goToStep = (stepName) => {
    Object.values(steps).forEach(step => step.classList.add('hidden'));
    if (steps[stepName]) {
        steps[stepName].classList.remove('hidden');
    }
};
	// POCZĄTEK NOWEJ FUNKCJI
const updateSummaryStats = () => {
    if (!appData.participants) return;

    let attendingCount = 0;
    let declinedCount = 0;
    let pendingCount = 0;

    appData.participants.forEach(p => {
        if (p.attending === true) {
            attendingCount++; // Osoba z listy
            if (p.guest) {
                attendingCount++; // Jej osoba towarzysząca
            }
        } else if (p.attending === false) {
            declinedCount++;
        } else { // p.attending jest null
            pendingCount++;
        }
    });

    document.getElementById('stats-attending').textContent = attendingCount;
    document.getElementById('stats-declined').textContent = declinedCount;
    document.getElementById('stats-pending').textContent = pendingCount;
};
const renderInviteCuisineGallery = () => {
    const gallery = document.getElementById('cuisine-gallery-invite');
    if (!gallery || !appData.participants || !appData.availableCuisines) return;

    gallery.innerHTML = '';

    const drawnCuisines = appData.participants
        .filter(p => p.cuisine)
        .map(p => {
            const parts = p.cuisine.split(' ');
            const icon = parts.pop();
            const name = parts.join(' ');
            return { name, icon };
        });

    const allCuisines = [...appData.availableCuisines, ...drawnCuisines];
    allCuisines.sort((a, b) => a.name.localeCompare(b.name));
    const availableNames = new Set(appData.availableCuisines.map(c => c.name));

    allCuisines.forEach(cuisine => {
        const item = document.createElement('div');
        item.className = 'carousel-item';
        if (!availableNames.has(cuisine.name)) {
            item.classList.add('unavailable');
        }
        item.innerHTML = `<span class="icon">${cuisine.icon}</span><span class="name">${cuisine.name}</span>`;
        gallery.appendChild(item);
    });
};

const renderHistoryTable = () => {
	updateSummaryStats();
	renderInviteCuisineGallery();
    historyBody.innerHTML = '';
    if (!appData.participants || appData.participants.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4">Brak danych o uczestnikach.</td></tr>';
        return;
    }
    appData.participants.forEach(p => {
        const row = document.createElement('tr');
        const attendingText = p.attending === null ? '❔' : (p.attending ? '✅ Tak' : '❌ Nie');
        const guestText = p.attending ? (p.guest ? '👤 Tak' : '➖ Nie') : '➖';
        const cuisineText = p.attending ? (p.cuisine || '<em>Czeka na losowanie</em>') : '➖';
        row.innerHTML = `<td data-label="Imię">${p.base}</td><td data-label="Obecność">${attendingText}</td><td data-label="+1">${guestText}</td><td data-label="Kuchnia">${cuisineText}</td>`;
        historyBody.appendChild(row);
    });
};

const initializeCarousel = (cuisines) => {
    carouselTrack.innerHTML = '';
    const extendedCuisines = [...cuisines, ...cuisines, ...cuisines, ...cuisines, ...cuisines];
    
    extendedCuisines.forEach(cuisine => {
        const item = document.createElement('div');
        item.className = 'carousel-item';
        item.innerHTML = `<span class="icon">${cuisine.icon}</span><span class="name">${cuisine.name}</span>`;
        carouselTrack.appendChild(item);
    });
};
	

// 5. LOGIKA DANYCH I API
const delay = ms => new Promise(res => setTimeout(res, ms));

const fetchWithRetry = async (url, options, retries = MAX_RETRIES) => {
    for (let i = 0; i <= retries; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                 throw new Error(`Błąd HTTP: ${response.status}`);
            }
            return response;
        } catch (error) {
            console.error(`Próba ${i + 1} nieudana:`, error.message);
            if (i === retries) {
                console.error("Osiągnięto maksymalną liczbę prób. Poddaję się.");
                throw error;
            }
            await delay(1000 * (i + 1)); // Czekaj 1, 2, 3... sekundy
        }
    }
};

	
	const cuisineTips = {
    "default": [
        "Ciekawe, kto pierwszy zapyta o hasło do Wi-Fi...",
        "Plotka głosi, że gospodarze ukryli najlepsze trunki. Czas na poszukiwania!",
        "Pamiętaj: kalorie zjedzone w dobrym towarzystwie nie tuczą. To fakt naukowy.",
        "Trwa zakulisowa walka o to, kto przyniesie najlepsze danie. Stawki są wysokie.",
        "Koty już oceniają, czyje kolana będą dziś najlepszym tronem. Przygotuj się.",
		"Jeśli komuś nie posmakuje jedzenie, zawsze możemy zamówić pizzę i udawać, że to kuchnia włoska.",
		 "Pamiętaj, impreza jest o 18 a nie 21:37!",
    "Wśród nas jest podobno kulinarny ekspert, który o każdym daniu powie 'ja bym to zrobił/a inaczej'.",
    "Jeśli jedzenie nie zostanie sfotografowane i wrzucone na Insta, to znaczy, że się nie liczy.",
    "Prosimy o nieporuszanie tematów polityki i religii. Chyba, że naprawdę lubicie chaos.",
    "Słuchajcie uważnie, bo najlepsze plotki będą serwowane między daniem głównym a deserem.",
    "Jeśli coś się przypali, wystarczy powiedzieć, że to 'wędzony' akcent. Nikt się nie zorientuje.",
    "Ktoś na pewno jest na diecie, ale pamiętajcie - 'jutro' to idealny dzień, żeby zacząć od nowa.",
    "Pamiętaj o zdjęciu butów. Gospodarze zainwestowali w nowy dywan, a nie chcemy 'inby'."
    ],
      "Niemiecka": [
        "Słyszałem, że ${name} wjeżdża ze sznyclem wielkości maski od Passata. To musi być prawda.",
        "Ciekawe, czy danie, które przygotuje ${name}, będzie miało niemiecką precyzję. Każdy ziemniak pod linijkę.",
        "${name} ma kuchnię niemiecką... Oby to nie był tylko wurst z musztardą, bo będzie 'zaorane'.",
        "Podobno ${name} robi sałatkę ziemniaczaną. Oby była tak solidna i niezawodna jak niemiecka motoryzacja.",
        "Mam nadzieję, że ${name} nie potraktuje nas samymi 'kartoflami'. Czekamy na kulinarny blitzkrieg!",
		  "Ciekawe, czy danie, które zrobi ${name}, będzie tak solidne jak Most Rędziński. Oczekujemy monumentalnej konstrukcji smaku!",
"Jeśli danie od ${name} będzie niedobre, to wyślemy je MPK na Psie Pole. I tak nie dojedzie."
    ],
    "Angielska": [
        "Kuchnia angielska... ${name}, liczymy, że to nie będzie fasolka na toście, bo zrobimy kulinarny Brexit.",
        "Ciekawe, czy ${name} o 17:00 zrobi przerwę na herbatkę. Z mlekiem czy bez?",
        "Jeśli ${name} robi Yorkshire pudding, to rezerwuję sobie od razu trzy. Na wynos też.",
        "Danie przygotowane przez ${name} albo będzie 'lovely', albo... cóż, przynajmniej pogoda jest ładna. Oh, wait.",
        "Fish & Chips? ${name}, mam nadzieję, że ryba nie będzie sucha jak angielski humor.",
		"Podobno ${name} robi danie tak blade, że wygląda jak turysta z Anglii po zwiedzaniu wrocławskiego Rynku w deszczu.",
"Fish & Chips? ${name}, mam nadzieję, że frytki nie będą tak wiotkie jak tory tramwajowe na Oławskiej."
    ],
    "Indyjska": [
        "${name} i kuchnia indyjska. Przygotujcie kubki smakowe na jazdę bez trzymanki... i szklanki z mlekiem.",
        "Podobno ${name} robi butter chicken tak kremowy, że aż chce się powiedzieć 'dej, mam horom curke na gluten'.",
        "Ciekawe, czy curry, które zaserwuje ${name}, będzie miało tyle kolorów, co scena tańca w filmie z Bollywood.",
        "Jeśli ${name} przywiezie coś naprawdę ostrego, to oficjalnie otwieramy zawody 'kto pierwszy zapłacze'.",
        "Ponoć ${name} potrafi tak doprawić danie, że smakuje jak podróż do Bombaju. Bez biletu i wizy.",
		"Słyszałem, że ${name} gotuje tak ostro, że aż krasnale pod domem szukają Odry, żeby się schłodzić.",
"Curry od ${name} podobno ma barwę ostrzegawczą, jak komunikaty MPK o kolejnym wykolejeniu. Wchodzimy na własne ryzyko!"
    ],
    "Gruziń.": [
        "Gaumarjos! ${name} i kuchnia gruzińska. Oby chaczapuri miało tyle sera, co kot napłakał... i to dużo kotów.",
        "Słyszałem, że ${name} szykuje chinkali. Będzie instruktaż jedzenia, żeby cały misterny plan nie poszedł w...",
        "Jeśli ${name} przyniesie prawdziwe gruzińskie wino, to toasty będą trwały do rana. Każdy po kolei.",
        "${name}, czy Twoje danie będzie tak gościnne i otwarte jak serca Gruzinów? Liczymy na to!",
        "Chodzą słuchy, że ${name} ma przepis na adżarskie tak dobry, że aż chce się tam zamieszkać.",
		"Jeśli chaczapuri, które zrobi ${name}, będzie miało za mało sera, to zrobimy taką inbę, jakiej Trójkąt Bermudzki nie widział.",
"Podobno ${name} toasty wznosi z takim zapałem, że aż Iglica się trzęsie. Czekamy na pokaz!"
    ],
    "Hiszp.": [
        "¡Olé! ${name} ma kuchnię hiszpańską. Czekamy na paellę czy raczej na sjestę po jedzeniu?",
        "Ciekawe, czy danie od ${name} będzie tak głośne i żywiołowe jak rozmowa Hiszpanów w barze tapas.",
        "Czy to prawda, że ${name} robi sangrię? Jeśli tak, to 'mañana' nikt nie idzie do pracy.",
        "Tapas to podobno nie jedzenie, to styl życia. ${name}, pokaż nam, jak się żyje!",
        "${name} i jego/jej patatas bravas... Oby sos był ostry jak temperament torreadora.",
		"Fiesta u ${name} będzie tak dobra, że skończymy o świcie, szukając drogi do domu jak zagubiony krasnal.",
"Czy to prawda, że sangria od ${name} jest tak mocna, że po jednym kubku tramwaj Plus sam wydaje się dobrym pomysłem?"
    ],
    "Francuska": [
        "Bonjour! ${name} i kuchnia francuska. Czy będzie coś, czego nazwy nie będziemy umieli wymówić?",
        "Jeśli ${name} robi zupę cebulową, to mam nadzieję, że będzie miała grzankę z serem grubą na palec.",
        "Podobno ${name} przyniesie ślimaki. Odważni zjedzą, reszta będzie robić zdjęcia na Insta.",
        "Elegancja-Francja! Ciekawe, czy danie od ${name} będzie wymagało użycia więcej niż jednego widelca.",
        "Crème brûlée? ${name}, liczymy na idealnie chrupiącą skorupkę. Będziemy stukać łyżeczkami!",
		"Podobno ${name} robi danie tak wykwintne, że je się je z zadartym nosem, patrząc z góry na innych jak z wieży Sky Tower.",
"Bagietka od ${name} jest podobno dłuższa niż korek na moście Grunwaldzkim w godzinach szczytu."
    ],
    "Czeska": [
        "Ahoj! ${name} gotuje po czesku. Oby knedliki były tak puszyste jak Krecik z bajki.",
        "Smažený sýr... ${name}, czy to prawda, że ser będzie się ciągnął aż do Pragi?",
        "Jeśli ${name} zrobi gulasz, to mam nadzieję, że będzie tak dobry, że aż sąsiedzi wpadną na kontrolę.",
        "Podobno do dania od ${name} najlepiej pasuje zimny napój chmielowy. Ktoś sprawdzał?",
        "Ciekawe, czy danie od ${name} będzie miało sens, czy to będzie 'czeski film'.",
		"Czeski film! ${name} gotuje tak blisko granicy, że aż czuć zapach knedlików na Dworcu Głównym.",
"Smažený sýr, który przygotuje ${name}, podobno będzie się ciągnął dłużej niż budowa tramwaju na Nowy Dwór."
    ],
    "Grecka": [
        "Opa! ${name} i kuchnia grecka! Czy będzie taniec Zorby i tłuczenie talerzy?",
        "Moussaka, którą rzekomo robi ${name}, ma podobno więcej warstw niż grecki dług publiczny.",
        "Jeśli ${name} zaserwuje fetę, to sprawdzimy, czy jest prawdziwa, czy to tylko 'ser typu greckiego'.",
        "Souvlaki? ${name}, mam nadzieję, że będą tak dobre, że aż bogowie na Olimpie poczują zazdrość.",
        "Czekamy na danie od ${name}. Oby było tak słoneczne i beztroskie jak wakacje na Krecie.",
		"Jeśli ${name} będzie tłuc talerze, to mam nadzieję, że z większą precyzją niż motorniczy MPK wjeżdżający na zwrotnicę.",
"Feta od ${name} ma być tak słona jak woda w Hydropolis. Prawda to?"
    ],
    "Japońska": [
        "Konnichiwa! ${name} i Japonia na talerzu. Oby sushi było zwinięte ciaśniej niż budżet na koniec miesiąca.",
        "Ciekawe, czy ${name} potrafi jeść pałeczkami, czy będzie prosić o 'sprzęt dla początkujących'.",
        "Podobno wasabi, które przyniesie ${name}, potrafi zresetować ustawienia fabryczne w mózgu.",
        "Ramen? ${name}, liczymy na bulion tak głęboki, jak przemyślenia po obejrzeniu anime Evangelion.",
        "Jeśli danie od ${name} będzie miało smak umami, to znaczy, że impreza jest udana.",
		"Sushi, które zrobi ${name}, musi być idealnie zwinięte. Inaczej będzie wstyd na całe Krzyki.",
"Ramen od ${name} ma podobno taką moc, że po zjedzeniu można zobaczyć wszystkie 600 wrocławskich krasnali naraz."
    ],
    "Koreań.": [
        "Annyeong! ${name} wlatuje z kuchnią koreańską. Oby kimchi nie pachniało na całą klatkę schodową.",
        "Bibimbap to podobno 'cały ten bałagan w misce'. ${name}, pokaż nam, jak się robi artystyczny nieład!",
        "Jeśli ${name} robi coś ostrego, to niech lepiej powie, gdzie jest najbliższy sklep z nabiałem.",
        "Fani K-Popu łączcie się! ${name} robi bulgogi. Może nawet zatańczymy jakiś układ?",
        "Danie od ${name} będzie tak dobre, że aż powiemy 'saranghaeyo' do talerza.",
		"Kimchi od ${name} jest ponoć tak intensywne w zapachu, że aż tynk odpada w Hali Stulecia.",
"Słyszałem, że danie od ${name} jest tak ostre, że aż Afrykarium wydaje się chłodnym, przyjemnym miejscem."
    ],
    "Meksyk.": [
        "¡Arriba! ${name} i kuchnia meksykańska! Pytanie wieczoru: jak ostre będzie 'średnio ostre'?",
        "Słyszałem, że ${name} robi guacamole tak dobre, że leczy złamane serca i pusty portfel.",
        "Jeśli ${name} przyniesie tacos, to niech nikt nie próbuje jeść ich nożem i widelcem. Będzie ban.",
        "Czy to prawda, że po daniu od ${name} będziemy krzyczeć 'AY, CARAMBA!'? Sprawdzimy.",
        "Mam nadzieję, że tequila do popicia też będzie. ${name}, nie zawiedź nas!",
		"Po zjedzeniu tacos od ${name} podobno robi się tak gorąco, że człowiek sam chce wskoczyć do fontanny na Rynku.",
"Jeśli danie od ${name} będzie zbyt ostre, to będziemy szukać pomocy szybciej niż MPK nowego autobusu na zastępstwo."
    ],
    "Portugalska": [
        "Olá! ${name} i kuchnia portugalska. Czy będzie Cristiano Ronaldo na talerzu? A nie, to tylko dorsz.",
        "Pastel de nata to podobno małe dzieła sztuki. ${name}, liczymy na Twoje zdolności artystyczne!",
        "Bacalhau można przyrządzić na 365 sposobów. Ciekawe, który z nich wybrał/a ${name}.",
        "Jeśli danie od ${name} będzie zawierać owoce morza, to miejmy nadzieję, że są świeższe niż newsy w TV.",
        "Portugalia to nie tylko Porto. ${name}, udowodnij, że Twoje danie jest równie warte odkrycia!",
				"Danie, które przygotuje ${name}, ma być tak dobre, że aż szkoda będzie jechać na wakacje do Portugalii. Wrocław wystarczy!",
"Pastel de nata od ${name}? Lepsze to niż stanie w kolejce do kas zoo w słoneczną niedzielę."
    ],
    "Tajska": [
        "Sawasdee! ${name} i kuchnia tajska. Balans smaków czy ostry chaos? Oto jest pytanie.",
        "Pad thai, które zrobi ${name}, musi mieć idealną harmonię. Jak yin i yang, tylko że z makaronem.",
        "Zielone curry od ${name}? Mam nadzieję, że jest na mleczku kokosowym, a nie na łzach naszych wrogów.",
        "Poziom ostrości 'dla Polaka' czy 'dla Taja'? ${name}, określ się, bo to kluczowa informacja.",
        "Jeśli jedzenie będzie dobre, to wszyscy zrobimy 'wai' (ukłon) w podziękowaniu dla ${name}.",
"Słyszałem, że ${name} gotuje tak ostro, że Odra zmienia swój bieg, byle dalej od tej kuchni.",
"Curry od ${name} ma być tak żółte jak stare tramwaje Konstal, które wciąż jeżdżą po mieście. Oby było smaczniejsze."
    ],
    "Turecka": [
        "Merhaba! ${name} i kuchnia turecka. Pytanie numer jeden: na grubym czy na cienkim?",
        "Jeśli ${name} robi baklavę, to lepiej schowajcie wagę na najbliższy tydzień. Będzie słodko i kalorycznie.",
        "Kebab od szefa kuchni ${name}. Oby był tak dobry, jak ten o 4 nad ranem w centrum miasta.",
        "Hummus, który podobno robi ${name}, jest tak kremowy, że można go używać jako maseczki. Ale lepiej zjeść.",
        "Ciekawe, czy ${name} będzie się targować o ostatni kawałek swojego dania. Jak na Grand Bazaar.",
		"Kebab od ${name} ma być tak dobry, że aż wszystkie budy z kebabem koło Dworca Głównego zwijają interes.",
"Czy to prawda, że ${name} robi kawę po turecku tak mocną, że stawia na nogi szybciej niż informacja o awarii na Moście Zwierzynieckim?"
    ],
    "Wietnam.": [
        "Xin chào! ${name} serwuje Wietnam. Czy zupa Pho będzie lekiem na całe zło tego świata? Miejmy nadzieję.",
        "Chrupanie sajgonek od ${name} podobno będzie słychać w całym województwie. Cisza na planie!",
        "Podobno ${name} robi Bánh mì. To kanapka tak legendarna, że ma własny fanklub. Zapisuję się!",
        "Kawa po wietnamsku też będzie? ${name}, nie rzucaj słów na wiatr, bo narobisz nadziei.",
        "Danie od ${name} będzie tak świeże i ziołowe, że poczujemy się jak na skuterze w Hanoi.",
		"Zupa Pho od ${name} podobno pachnie tak intensywnie, że czuć ją aż na Psim Polu, mimo że ${name} mieszka na Gądowie.",
"Sajgonki od ${name} będą tak chrupiące, jak dźwięk wykolejającego się tramwaju. Oby były przyjemniejsze w odbiorze."
    ],
    "Włoska": [
        "Mamma mia! ${name} i kuchnia włoska. Ananas na pizzy jest oficjalnie zakazany, prawda?",
        "Podobno tiramisu, które robi ${name}, jest tak dobre, że anioły śpiewają. Czekamy na ten niebiański chór.",
        "Spaghetti od ${name}? Ciekawe, kto pierwszy upapra sobie całą koszulę sosem.",
        "Jeśli ${name} robi carbonarę, to sprawdzimy, czy jest na śmietanie. Będzie afera.",
        "Włosi podobno rozmawiają rękami. Ciekawe, czy danie od ${name} będzie tak ekspresyjne.",
		"Pizza od ${name} ma być tak duża, że trzeba ją będzie transportować jak elementy Mostu Rędzińskiego.",
"Jeśli carbonara od ${name} będzie na śmietanie, to chyba kogoś wyślemy na przymusowe zwiedzanie Hydropolis, dla zrozumienia, czym jest woda."
    ],
    "Polska": [
        "No siema! ${name} i kuchnia polska. Schabowy będzie z kostką czy bez? To ważne.",
        "Pierogi od ${name}... Lepsze niż u mamy? Odważna deklaracja, zobaczymy, co z tego wyjdzie.",
        "Słyszałem, że bigos, który gotuje ${name}, ma tyle lat, co węgiel. Musi być dobry.",
        "Jeśli ${name} zrobił/a sałatkę jarzynową, to pytanie brzmi: z groszkiem czy bez? To dzieli rodziny.",
        "Rosół od ${name} podobno leczy wszystko, od kaca po złamane serce. Potrzebujemy go!",
		"Schabowy od ${name} podobno będzie tak duży, że przykryje cały Rynek, razem z krasnalami.",
"Bigos, który przynosi ${name}, jest podobno tak kwaśny, że aż mordki lwów przy Placu Jana Pawła II się wykrzywiają."
    ]
};
	

	// --- NOWY SYSTEM POWIADOMIEŃ TOAST ---

// Globalna playlista i interwał
let messagePlaylist = [];
let toastInterval = null;

// Funkcja do pokazywania pojedynczego powiadomienia
// ZASTĄP TĘ FUNKCJĘ PONIŻSZĄ WERSJĄ
const showToast = (message) => {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const isMobile = window.innerWidth <= 768;
    const maxToasts = isMobile ? 1 : 6;

    if (isMobile && container.children.length > 0) {
        for (const child of container.children) {
             child.classList.add('exit');
             setTimeout(() => child.remove(), 500);
        }
    }

    while (container.children.length >= maxToasts) {
        const oldestToast = container.children[0];
        oldestToast.classList.add('exit');
        setTimeout(() => oldestToast.remove(), 500);
        oldestToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification';

    // --- NOWA LOGIKA DO STYLOWANIA IMIENIA ---
    // Zamieniamy %%Imię%% na <span class="toast-name-highlight">Imię</span>
    const styledMessage = message.replace(/%%(.*?)%%/g, `<span class="toast-name-highlight">$1</span>`);
    
    // Używamy innerHTML zamiast textContent, aby style zadziałały
    toast.innerHTML = styledMessage;

    toast.addEventListener('animationend', () => {
        toast.remove();
    });

    container.appendChild(toast);
};

// Główna funkcja inicjująca system
// ZASTĄP CAŁĄ STARĄ FUNKCJĘ TĄ NOWĄ WERSJĄ
const initializeToastSystem = () => {
    // Pule tekstów: osobno domyślne, osobno spersonalizowane
    let defaultTips = [];
    let personalizedTipsPool = []; // Struktura: [{ name: 'Imię', tips: ['tekst 1', 'tekst 2'] }]
    
    // Ta funkcja buduje pulę spersonalizowanych tekstów na podstawie aktualnych danych
    const updatePools = () => {
        // Zawsze pobieraj świeżą listę domyślnych tekstów
        defaultTips = [...cuisineTips.default];

        // Wyczyść i zbuduj na nowo pulę spersonalizowanych tekstów
        personalizedTipsPool = [];
        const confirmedGuests = appData.participants.filter(p => p.attending === true && p.cuisine);

        if (confirmedGuests.length > 0) {
            confirmedGuests.forEach(guest => {
                const cuisineFullName = guest.cuisine;
                const cuisineBaseName = Object.keys(cuisineTips).find(key => cuisineFullName.startsWith(key));
                
                if (cuisineBaseName && cuisineTips[cuisineBaseName]) {
                    // Dodajemy obiekt z imieniem i *szablonami* tekstów
                    personalizedTipsPool.push({
                        name: guest.base,
                        tips: cuisineTips[cuisineBaseName]
                    });
                }
            });
        }
    };

    // Uruchom interwał, który będzie losował i wyświetlał powiadomienia
    if (toastInterval) clearInterval(toastInterval);

    toastInterval = setInterval(() => {
        let message = "";

        // Losowanie: 75% szans na tekst spersonalizowany (jeśli są dostępne)
        if (personalizedTipsPool.length > 0 && Math.random() < 0.75) {
            // 1. Wylosuj osobę
            const randomPersonIndex = Math.floor(Math.random() * personalizedTipsPool.length);
            const personData = personalizedTipsPool[randomPersonIndex];
            
            // 2. Wylosuj tekst dla tej osoby
            const randomTipIndex = Math.floor(Math.random() * personData.tips.length);
            const tipTemplate = personData.tips[randomTipIndex];
            
            // 3. Wstaw imię do szablonu (ze znacznikami do kolorowania)
            message = tipTemplate.replace(/\$\{name\}/g, `%%${personData.name}%%`);
        } else {
            // W przeciwnym wypadku (lub gdy nie ma tekstów spersonalizowanych), wylosuj tekst domyślny
            if (defaultTips.length > 0) {
                const randomDefaultIndex = Math.floor(Math.random() * defaultTips.length);
                message = defaultTips[randomDefaultIndex];
            }
        }

        // Jeśli udało się wylosować wiadomość, pokaż ją
        if (message) {
            showToast(message);
        }
    }, 5000); // Nowe powiadomienie co 5 sekund

    // Zaktualizuj pule po raz pierwszy (zanim załadują się dane, `personalizedTipsPool` będzie puste)
    updatePools();

    // Zwróć funkcję aktualizującą, aby `loadData` mogło jej użyć
    return updatePools;
};
	
const loadData = async () => {
    try {
        const response = await fetchWithRetry(GOOGLE_SCRIPT_URL); 
        const data = await response.json();
        appData = data;
        renderHistoryTable();
        populatePersonSelect();
        populateRefuseSelect();
		        if (window.updateToastPools) window.updateToastPools();
    } catch (error) {
        console.error("Błąd ładowania danych z Google Sheets:", error);
        historyBody.innerHTML = '<tr><td colspan="4">Nie udało się załadować danych. Odśwież stronę.</td></tr>';
    }
};

const saveData = async () => {
    try {
        await fetchWithRetry(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            redirect: "follow", 
            headers: {
                "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify(appData)
        });
        // Po zapisie odświeżamy dane, aby mieć pewność, że wszystko jest aktualne
        await loadData();
    } catch (error) {
        console.error("Błąd zapisu danych do Google Sheets:", error);
        resultAnnouncement.innerHTML = `<h2 style="color:red">Błąd zapisu! Spróbuj ponownie.</h2>`;
    }
};


const populatePersonSelect = () => {
    personSelect.innerHTML = '';
    let availablePeople = 0;
    if (appData.participants) {
        appData.participants.forEach(p => {
            if (p.attending === null || (p.attending && !p.cuisine)) {
                const option = document.createElement('option');
                option.value = p.base;
                option.textContent = p.declined;
                personSelect.appendChild(option);
                availablePeople++;
            }
        });
    }
    if (availablePeople === 0) {
        document.getElementById('step-details').innerHTML = '<p>Wygląda na to, że wszyscy już wzięli udział. Zobacz wyniki poniżej!</p>';
    }
};

const startCarousel = () => {
    if (isSpinning) return;
    const availableCuisines = appData.availableCuisines;
    if (!availableCuisines || availableCuisines.length === 0) {
        alert("Wszystkie kuchnie zostały już wylosowane!");
        return;
    }

    isSpinning = true;
    spinButton.disabled = true;

    const randomIndex = Math.floor(Math.random() * availableCuisines.length);
    const selectedCuisine = availableCuisines[randomIndex];

    const targetIndex = availableCuisines.length + randomIndex;
    const itemWidth = 120;
    const targetPosition = - (targetIndex * itemWidth) + (carouselTrack.parentElement.clientWidth / 2) - (itemWidth / 2);

    carouselTrack.classList.add('spinning');
    carouselTrack.style.left = `${targetPosition}px`;

    setTimeout(async () => {
        const cuisineString = selectedCuisine.name + " " + selectedCuisine.icon;
        resultAnnouncement.innerHTML = `<h2>Gratulacje, <span style="color:var(--primary-color)">${currentUser.name}!</span></h2>
                                      <p>Twoje przeznaczenie to: <strong>${cuisineString}</strong></p>`;
        
        const personIndex = appData.participants.findIndex(p => p.base === currentUser.name);
        if (personIndex > -1) {
            appData.participants[personIndex].cuisine = cuisineString;
            appData.availableCuisines.splice(randomIndex, 1);
        }
        
        await saveData();
        isSpinning = false;
        contentWrapper.classList.add('hidden');
    }, 5100);
};
// DODAJ całą tę nową funkcję
const populateRefuseSelect = () => {
    const refuseSelect = document.getElementById('refuse-person-select');
    refuseSelect.innerHTML = '';
    let availablePeople = 0;
    if (appData.participants) {
        appData.participants.forEach(p => {
            // Pokaż osoby niezdecydowane (null) lub te, które już potwierdziły (true)
            if (p.attending === null || p.attending === true) {
                const option = document.createElement('option');
                option.value = p.base;
                option.textContent = p.declined;
                refuseSelect.appendChild(option);
                availablePeople++;
            }
        });
    }
    if (availablePeople === 0) {
        document.getElementById('step-refuse').innerHTML = '<p>Wygląda na to, że wszyscy już podjęli ostateczną decyzję!</p>';
    }
};

// DODAJ całą tę nową funkcję
const handleRefusal = async () => {
    const refuseSelect = document.getElementById('refuse-person-select');
    const name = refuseSelect.value;
    if (!name) return;

    // Pętla z męczącymi pytaniami
    for (const question of naggingQuestions) {
        if (!confirm(question)) {
            alert("Uff, co za ulga! Dobrze, że zostajesz! 😄");
            goToStep('invite');
            return; // Przerwij proces odmowy
        }
    }

    const personIndex = appData.participants.findIndex(p => p.base === name);
    if (personIndex > -1) {
        const person = appData.participants[personIndex];

        // Sprawdź, czy osoba miała przypisaną kuchnię
        if (person.cuisine) {
            const cuisineString = person.cuisine;
            // Proste parsowanie: "Nazwa Kuchni  эмодзи"
            const parts = cuisineString.split(' ');
            const icon = parts.pop();
            const cuisineName = parts.join(' ');
            
            // Stwórz obiekt kuchni i dodaj go z powrotem do puli
            const returnedCuisine = { name: cuisineName, icon: icon };
            appData.availableCuisines.push(returnedCuisine);
            
            // Opcjonalnie: sortuj listę kuchni dla porządku
            appData.availableCuisines.sort((a, b) => a.name.localeCompare(b.name));
        }

        // Zaktualizuj dane osoby
        person.attending = false;
        person.guest = false; // Resetuj osobę towarzyszącą
        person.cuisine = null; // Usuń kuchnię

        await saveData();
        contentWrapper.classList.add('hidden');
        resultAnnouncement.innerHTML = `<h2>Szkoda, że Cię nie będzie, ${name}.</h2><p>Dzięki za informację! Do zobaczenia następnym razem.</p>`;
    }
};

// 7. INICJALIZACJA I OBSŁUGA ZDARZEŃ
document.addEventListener('DOMContentLoaded', () => {
    
    document.getElementById('btn-attend-yes').addEventListener('click', () => {
	    goToStep('details');
	    // DODANA LINIA: Płynne przewinięcie do nowego widoku
	    document.getElementById('step-details').scrollIntoView({ behavior: 'smooth', block: 'center' });
	});

    document.getElementById('btn-attend-no').addEventListener('click', () => {
		goToStep('refuse');
	});
	
	document.getElementById('btn-confirm-refusal').addEventListener('click', handleRefusal);
	document.getElementById('btn-cancel-refusal').addEventListener('click', () => goToStep('invite'));
    
    document.getElementById('btn-to-drawing').addEventListener('click', () => {
        currentUser.name = personSelect.value;
        const personData = appData.participants.find(p => p.base === currentUser.name);

        if (personData && personData.cuisine) {
            alert('Już brałeś/aś udział w losowaniu! Zobacz swój wynik w tabeli.');
            contentWrapper.classList.add('hidden');
            resultAnnouncement.innerHTML = `<h2>Twój wynik jest już w tabeli, ${personData.base}!</h2>`;
            return;
        }

        const personIndex = appData.participants.findIndex(p => p.base === currentUser.name);
        if (personIndex > -1) {
            appData.participants[personIndex].attending = true;
            appData.participants[personIndex].guest = document.querySelector('input[name="guest"]:checked').value === 'yes';
        }
        
        initializeCarousel(appData.availableCuisines);
        goToStep('drawing');
		
    });

    spinButton.addEventListener('click', startCarousel);
    
    loadData();
    goToStep('invite');
	    window.updateToastPools = initializeToastSystem();
});
// --- DODATKOWA LOGIKA DLA GALERII MAP ---
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const galleryImages = document.querySelectorAll('.map-gallery img');

    galleryImages.forEach(img => {
        img.addEventListener('click', () => {
            lightbox.classList.remove('hidden');
            lightbox.classList.add('active');
            lightboxImg.src = img.src;
        });
    });

    lightbox.addEventListener('click', (e) => {
        if (e.target !== e.currentTarget && e.target.tagName !== 'SPAN') return;
        lightbox.classList.remove('active');
        setTimeout(() => {
            lightbox.classList.add('hidden');
        }, 300);
    });
	const partyDate = new Date('2025-10-04T18:00:00').getTime();
const countdownInterval = setInterval(() => {
    const now = new Date().getTime();
    const distance = partyDate - now;

    if (distance < 0) {
        clearInterval(countdownInterval);
        document.getElementById('countdown-timer').innerHTML = "<h2>Impreza trwa w najlepsze!</h2>";
        return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    document.getElementById('days').innerText = String(days).padStart(2, '0');
    document.getElementById('hours').innerText = String(hours).padStart(2, '0');
    document.getElementById('minutes').innerText = String(minutes).padStart(2, '0');
    document.getElementById('seconds').innerText = String(seconds).padStart(2, '0');
}, 1000);

</script>

</body>
</html>
































